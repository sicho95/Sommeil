<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, user-scalable=no">
    <title>Suivi Bébé - Sommeil</title>
    <link rel="icon" href="data:;base64,iVBORw0KGgo=">
    <style>
        :root {
            --primary: #2180F0; --secondary: #8B5E40; --bg: #FCF9F9; --surface: #FFFFFF;
            --text: #134252; --text-secondary: #62746B; --border: #DDD5D0;
            --coucher: #1E4F66; --reveils: #E68361; --reveilmatin: #F5AE0B;
            --siestematin: #22C55E; --siesteapres: #06B6D4; --repasmidi: #EC4899;
            --repasoir: #A855F7;
        }
        [data-theme="dark"] {
            --bg: #1F2121; --surface: #262828; --text: #F5F5F5; --text-secondary: #A7A9A9; --border: #4D5555;
            --primary: #32B8C6;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: -apple-system, system-ui, sans-serif; }
        body { background: var(--bg); color: var(--text); padding: env(safe-area-inset-top) env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left); min-height: 100vh; }
        .header { background: var(--surface); padding: 16px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
        .date { font-size: 20px; font-weight: 500; }
        .arrow { width: 44px; height: 44px; border-radius: 8px; background: var(--primary); color: white; border: none; font-size: 18px; cursor: pointer; }
        .arrow:active { opacity: 0.8; }
        .cards { display: flex; flex-direction: column; gap: 12px; padding: 16px; max-width: 390px; margin: 0 auto; }
        @media (min-width: 768px) { .cards { display: grid; grid-template-columns: repeat(2, 1fr); gap: 16px; padding: 24px; } }
        @media (min-width: 1024px) { .cards { grid-template-columns: repeat(3, 1fr); } }
        .card { background: var(--surface); border-radius: 12px; padding: 20px; border: 1px solid var(--border); box-shadow: 0 2px 8px rgba(0,0,0,0.08); cursor: pointer; transition: all 0.2s; }
        .card:active { transform: scale(0.98); }
        .card-header { display: flex; align-items: center; margin-bottom: 12px; }
        .card-color { width: 8px; height: 40px; border-radius: 4px; margin-right: 12px; }
        .card.coucher .card-color { background: var(--coucher); }
        .card.reveils .card-color { background: var(--reveils); }
        .card.reveilmatin .card-color { background: var(--reveilmatin); }
        .card.sieste-matin .card-color { background: var(--siestematin); }
        .card.sieste-apres .card-color { background: var(--siesteapres); }
        .card.repas-soir .card-color { background: var(--repasoir); }
        .card-title { font-size: 18px; font-weight: 500; flex: 1; }
        .card-summary { font-size: 16px; color: var(--text-secondary); margin-bottom: 12px; }
        .btn-primary { background: var(--primary); color: white; border: none; padding: 12px 24px; border-radius: 8px; font-size: 16px; min-height: 44px; cursor: pointer; width: 100%; }
        .btn-primary:active { opacity: 0.8; }
        .tabbar { position: fixed; bottom: 0; left: 0; right: 0; background: var(--surface); border-top: 1px solid var(--border); display: flex; padding-bottom: env(safe-area-inset-bottom); }
        .tab { flex: 1; padding: 12px; text-align: center; border: none; background: none; color: var(--text-secondary); cursor: pointer; font-size: 12px; }
        .tab.active { color: var(--primary); font-weight: 500; }
        .tab:active { opacity: 0.8; }
        .modal { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: none; align-items: center; justify-content: center; z-index: 1000; padding: 20px; }
        .modal.active { display: flex; }
        .modal-content { background: var(--surface); border-radius: 16px; padding: 24px; max-width: 90vw; max-height: 80vh; overflow-y: auto; width: 100%; }
        .form-group { margin-bottom: 20px; }
        .form-label { display: block; font-size: 16px; margin-bottom: 8px; font-weight: 500; }
        .time-input, .select, input { width: 100%; padding: 12px; border: 1px solid var(--border); border-radius: 8px; font-size: 16px; background: var(--bg); }
        .segment { display: flex; background: var(--bg); border-radius: 8px; overflow: hidden; border: 1px solid var(--border); }
        .segment-btn { flex: 1; padding: 12px; border: none; background: none; cursor: pointer; }
        .segment-btn.active { background: var(--primary); color: white; }
        .synthese { padding: 24px; max-width: 600px; margin: 0 auto; }
        .stat { background: var(--surface); padding: 20px; border-radius: 12px; margin-bottom: 16px; border-left: 4px solid var(--primary); }
        .stat-total { font-size: 32px; font-weight: 700; color: var(--primary); }
        .param-section { background: var(--surface); margin-bottom: 16px; padding: 20px; border-radius: 12px; border: 1px solid var(--border); }
        .danger-btn { background: #E63866 !important; }
        .page { display: none; }
        .page.active { display: block; }
    </style>
</head>
<body>
    <header class="header">
        <button class="arrow" onclick="changeDay(-1)">‹</button>
        <div class="date" id="currentDate">Samedi 29 novembre 2025</div>
        <button class="arrow" onclick="changeDay(1)">›</button>
    </header>

    <main class="page active" id="page-jour">
        <div class="cards" id="cardsContainer">
            <!-- Cartes générées par JS -->
        </div>
    </main>

    <main class="page" id="page-synthese">
        <div class="synthese">
            <div class="stat">
                <div class="stat-total" id="totalSommeil">0h 0min</div>
                <div>Sommeil total journée</div>
            </div>
            <div class="stat">
                <div id="qualiteNuit">Qualité nuit : --</div>
                <div>Réveils : <span id="nbReveils">0</span></div>
            </div>
            <div class="stat">
                <div id="comparaisonAge">Besoins : --h</div>
            </div>
            <div class="stat">
                <h3>Analyse</h3>
                <div id="analyseCauses">Aucune donnée</div>
            </div>
        </div>
    </main>

    <main class="page" id="page-parametres">
        <div class="param-section">
            <h3>Enfant actuel</h3>
            <select class="select" id="selectEnfant" onchange="changeEnfant(this.value)">
                <option>Aucun enfant</option>
            </select>
            <button class="btn-primary" onclick="openModal('creer-enfant')">+ Créer enfant</button>
        </div>
        <div class="param-section">
            <h3>Thème</h3>
            <div class="segment">
                <button class="segment-btn active" data-theme="light" onclick="setTheme('light')">Clair</button>
                <button class="segment-btn" data-theme="dark" onclick="setTheme('dark')">Sombre</button>
                <button class="segment-btn" data-theme="auto" onclick="setTheme('auto')">Auto</button>
            </div>
        </div>
        <div class="param-section">
            <button class="btn-primary danger-btn" onclick="supprimerEnfant()">Supprimer enfant</button>
        </div>
    </main>

    <nav class="tabbar">
        <button class="tab active" onclick="showTab('jour')">Jour</button>
        <button class="tab" onclick="showTab('synthese')">Synthèse</button>
        <button class="tab" onclick="showTab('parametres')">Paramètres</button>
    </nav>

    <div class="modal" id="modal">
        <div class="modal-content">
            <h2 id="modalTitle">Modal</h2>
            <div id="modalContent"></div>
            <div style="display: flex; gap: 12px; margin-top: 24px;">
                <button class="btn-primary" onclick="saveModal()" style="flex: 1;">Enregistrer</button>
                <button onclick="closeModal()" style="flex: 1; background: transparent; border: 1px solid var(--border);">Annuler</button>
            </div>
        </div>
    </div>

    <script>
        // === APP STATE - INITIALISÉ EN PREMIER ===
        const appState = {
            currentDay: new Date(),
            currentEnfant: null,
            data: { mois: new Date().toISOString().slice(0, 7), jours: {} },
            enfants: JSON.parse(localStorage.getItem('enfants')) || {},
            theme: localStorage.getItem('theme') || 'auto',
            currentModal: ''
        };

        // === SERVICES ===
        const storageService = {
            loadData() {
                if (appState.currentEnfant) {
                    const saved = localStorage.getItem(`babyData_${appState.currentEnfant}`);
                    if (saved) appState.data = JSON.parse(saved);
                }
            },
            saveData() {
                if (appState.currentEnfant) {
                    localStorage.setItem(`babyData_${appState.currentEnfant}`, JSON.stringify(appState.data));
                }
            }
        };

        const calcService = {
            calculerTotalSommeil(jour) {
                let total = 0;
                if (jour.coucher?.heureCoucher && jour.reveilMatin?.heureReveil) {
                    const debut = this.parseTime(jour.coucher.heureCoucher);
                    const fin = this.parseTime(jour.reveilMatin.heureReveil);
                    total += Math.max(0, (fin - debut) / 60000);
                }
                total += (jour.siesteMatin?.duree || 0) + (jour.siesteApresmidi?.duree || 0);
                return total;
            },
            parseTime(timeStr) {
                const [h, m] = timeStr.split(':').map(Number);
                return (h * 60 + m) * 60000;
            },
            formatMinutes(minutes) {
                const h = Math.floor(minutes / 60);
                const m = minutes % 60;
                return `${h}h ${m}min`;
            },
            getBesoinsAge(age) {
                if (age <= 2) return {min: 16, max: 17};
                if (age <= 5) return {min: 14, max: 16};
                if (age <= 11) return {min: 12, max: 15};
                return {min: 11, max: 14};
            },
            evaluerQualiteNuit(jour) {
                const reveils = jour.reveils?.length || 0;
                if (reveils === 0) return "Bonne nuit ✓";
                if (reveils <= 2) return "Nuit normale";
                return "Nuit perturbée ⚠";
            }
        };

        const enfantManager = {
            lister() { return Object.keys(appState.enfants); },
            creer(nom, age, poids) {
                appState.enfants[nom] = { age: parseInt(age), poids: parseFloat(poids) || 0, nom };
                localStorage.setItem('enfants', JSON.stringify(appState.enfants));
                appState.currentEnfant = nom;
            },
            supprimer(conserverServeur) {
                if (!conserverServeur) delete appState.enfants[appState.currentEnfant];
                localStorage.setItem('enfants', JSON.stringify(appState.enfants));
                storageService.saveData();
                appState.currentEnfant = null;
                updateEnfantsList();
            }
        };

        // === UI ===
        function initApp() {
            updateDate();
            updateEnfantsList();
            storageService.loadData();
            updateCards();
            applyTheme();
            updateSynthese();
        }

        function updateDate() {
            const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
            document.getElementById('currentDate').textContent = appState.currentDay.toLocaleDateString('fr-FR', options);
        }

        function changeDay(delta) {
            appState.currentDay.setDate(appState.currentDay.getDate() + delta);
            updateDate();
            updateCards();
        }

        function updateCards() {
            const dayKey = appState.currentDay.toISOString().split('T')[0];
            const jour = appState.data.jours[dayKey] || {};

            const cardsData = [
                {id: 'coucher', title: 'Coucher du soir', summary: jour.coucher ? jour.coucher.heureCoucher || '✓' : 'Non renseigné', class: 'coucher'},
                {id: 'reveils', title: 'Réveils nocturnes', summary: jour.reveils ? `${jour.reveils.length} réveils` : 'Non renseigné', class: 'reveils'},
                {id: 'reveilmatin', title: 'Réveil du matin', summary: jour.reveilMatin ? jour.reveilMatin.heureReveil || '' : 'Non renseigné', class: 'reveilmatin'},
                {id: 'siestematin', title: 'Sieste du matin', summary: jour.siesteMatin ? `${jour.siesteMatin.duree}min` : 'Non renseigné', class: 'sieste-matin'},
                {id: 'siesteapres', title: 'Sieste après-midi', summary: jour.siesteApresmidi ? `${jour.siesteApresmidi.duree}min` : 'Non renseigné', class: 'sieste-apres'},
                {id: 'repas-soir', title: 'Repas du soir', summary: jour.repasSoir ? jour.repasSoir.qualite : 'Non renseigné', class: 'repas-soir'}
            ];

            document.getElementById('cardsContainer').innerHTML = cardsData.map(card => 
                `<div class="card ${card.class}" onclick="openModal('${card.id}')">
                    <div class="card-header">
                        <div class="card-color"></div>
                        <div class="card-title">${card.title}</div>
                    </div>
                    <div class="card-summary">${card.summary}</div>
                    <button class="btn-primary">Modifier</button>
                </div>`
            ).join('');
        }

        function updateEnfantsList() {
            const select = document.getElementById('selectEnfant');
            select.innerHTML = '<option>Aucun enfant</option>' + 
                enfantManager.lister().map(nom => `<option>${nom}</option>`).join('');
            if (appState.currentEnfant) select.value = appState.currentEnfant;
        }

        function updateSynthese() {
            const dayKey = appState.currentDay.toISOString().split('T')[0];
            const jour = appState.data.jours[dayKey] || {};
            const totalMin = calcService.calculerTotalSommeil(jour);
            const enfant = appState.currentEnfant ? appState.enfants[appState.currentEnfant] : null;

            document.getElementById('totalSommeil').textContent = calcService.formatMinutes(totalMin);
            document.getElementById('qualiteNuit').textContent = calcService.evaluerQualiteNuit(jour);
            document.getElementById('nbReveils').textContent = jour.reveils?.length || 0;

            if (enfant) {
                const besoins = calcService.getBesoinsAge(enfant.age);
                document.getElementById('comparaisonAge').textContent = `Besoins ${enfant.age} mois: ${besoins.min}-${besoins.max}h`;
            }
        }

        function openModal(type) {
            appState.currentModal = type;
            document.getElementById('modal').classList.add('active');

            const modalContent = {
                'coucher': '<div class="form-group"><label class="form-label">Heure coucher</label><input type="time" class="time-input" id="coucherTime"></div><div class="form-group"><label>Commentaire</label><select class="select" id="coucherComment"><option>Facile</option><option>Difficile</option><option>Sucette</option></select></div>',
                'reveils': '<div class="form-group"><label>Nb réveils</label><input type="number" class="select" id="reveilsCount" min="0" value="0"></div>',
                'reveilmatin': '<div class="form-group"><label>Heure réveil</label><input type="time" class="time-input" id="reveilTime"></div>',
                'siestematin': '<div class="form-group"><label>Durée (min)</label><input type="number" class="select" id="siesteMatinDuree"></div>',
                'siesteapres': '<div class="form-group"><label>Durée (min)</label><input type="number" class="select" id="siesteApresDuree"></div>',
                'repas-soir': '<div class="form-group"><label>Qualité</label><div class="segment"><button class="segment-btn active" data-value="bien">Bien mangé</button><button class="segment-btn" data-value="peu">Peu mangé</button><button class="segment-btn" data-value="rien">Rien mangé</button></div></div>',
                'creer-enfant': '<div class="form-group"><label>Nom</label><input type="text" class="select" id="enfantNom" placeholder="Prénom"></div><div class="form-group"><label>Âge (mois)</label><input type="number" class="select" id="enfantAge" min="0"></div>'
            };

            document.getElementById('modalTitle').textContent = type.replace('-', ' ').replace('creer ', '').toUpperCase();
            document.getElementById('modalContent').innerHTML = modalContent[type] || 'En développement';
        }

        function closeModal() {
            document.getElementById('modal').classList.remove('active');
        }

        function saveModal() {
            const dayKey = appState.currentDay.toISOString().split('T')[0];
            if (!appState.data.jours[dayKey]) appState.data.jours[dayKey] = {};
            const jour = appState.data.jours[dayKey];

            switch(appState.currentModal) {
                case 'coucher':
                    jour.coucher = { heureCoucher: document.getElementById('coucherTime')?.value, commentaire: document.getElementById('coucherComment')?.value };
                    break;
                case 'reveils':
                    jour.reveils = Array(parseInt(document.getElementById('reveilsCount')?.value || 0)).fill({});
                    break;
                case 'reveilmatin':
                    jour.reveilMatin = { heureReveil: document.getElementById('reveilTime')?.value };
                    break;
                case 'siestematin':
                    jour.siesteMatin = { duree: parseInt(document.getElementById('siesteMatinDuree')?.value || 0) };
                    break;
                case 'siesteapres':
                    jour.siesteApresmidi = { duree: parseInt(document.getElementById('siesteApresDuree')?.value || 0) };
                    break;
                case 'repas-soir':
                    jour.repasSoir = { qualite: document.querySelector('[data-value].active')?.dataset.value || 'bien' };
                    break;
                case 'creer-enfant':
                    const nom = document.getElementById('enfantNom').value.trim();
                    if (nom) enfantManager.creer(nom, document.getElementById('enfantAge').value, 0);
                    break;
            }

            storageService.saveData();
            updateCards();
            updateSynthese();
            closeModal();
        }

        function changeEnfant(nom) {
            if (nom !== 'Aucun enfant') {
                appState.currentEnfant = nom;
                storageService.loadData();
                updateCards();
                updateSynthese();
            }
        }

        function setTheme(theme) {
            appState.theme = theme;
            localStorage.setItem('theme', theme);
            applyTheme();
            document.querySelectorAll('.segment-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
        }

        function applyTheme() {
            if (appState.theme === 'auto') {
                document.documentElement.setAttribute('data-theme', window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light');
            } else {
                document.documentElement.setAttribute('data-theme', appState.theme);
            }
        }

        function supprimerEnfant() {
            if (!appState.currentEnfant) return alert('Aucun enfant');
            if (confirm('Supprimer ' + appState.currentEnfant + ' ?')) {
                enfantManager.supprimer(false);
                updateCards();
            }
        }

        function showTab(tabName) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.getElementById('page-' + tabName).classList.add('active');
            event.target.classList.add('active');
            if (tabName === 'synthese') updateSynthese();
        }

        // === INIT ===
        document.addEventListener('DOMContentLoaded', initApp);
    </script>
</body>
</html>